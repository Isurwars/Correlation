// Correlation - Liquid and Amorphous Solid Analysis Tool
// Copyright © 2013-2026 Isaías Rodríguez (isurwars@gmail.com)
// SPDX-License-Identifier: MIT
// Full license: https://github.com/Isurwars/Correlation/blob/main/LICENSE

import {
    MaterialStyleMetrics,
    MaterialTypography,
    CheckBox,
    CheckState,
    TextField,
    DropDownMenu,
    OutlinedCard,
    MaterialText,
    Icon,
    Icons,
    MaterialPalette,
    ScrollView,
} from "@material";
import { BondCutoff } from "Types.slint";

export component OptionsCard inherits OutlinedCard {
    in property <bool> file_loaded;
    in-out property <string> r_max;
    in-out property <string> r_bin_width;
    in-out property <string> q_max;
    in-out property <string> q_bin_width;
    in-out property <string> r_int_max;
    in-out property <string> angle_bin_width;
    in-out property <bool> smoothing: true;
    in-out property <bool> use_hdf5: true;
    in-out property <bool> use_csv: true;
    in-out property <string> smoothing_sigma;
    in-out property <int> smoothing_kernel;
    in-out property <[BondCutoff]> bond_cutoffs;
    
    // Toggle stats for groups
    property <bool> rdf_expanded: true;
    property <bool> sq_expanded: false;
    property <bool> angle_expanded: false;
    property <bool> smoothing_expanded: false;
    property <bool> bond_cutoffs_expanded: false;

    // Toggle height for groups
    property <length> rdf_height: rdf_expanded ? 100px : 0px;
    property <length> sq_height: sq_expanded ? 150px : 0px;
    property <length> angle_height: angle_expanded ? 50px : 0px;
    property <length> smoothing_height: smoothing_expanded ? 100px : 0px;
    property <length> bond_cutoffs_height: bond_cutoffs_expanded ? 150px : 0px;
  
    // Hover states for tooltips
    out property <bool> r_max_has_hover: r_max_area.has-hover;
    out property <bool> r_bin_has_hover: r_bin_area.has-hover;
    out property <bool> q_max_has_hover: q_max_area.has-hover;
    out property <bool> r_int_has_hover: r_int_area.has-hover;
    out property <bool> theta_bin_has_hover: theta_bin_area.has-hover;
    out property <bool> q_bin_has_hover: q_bin_area.has-hover;

    out property <bool> sigma_has_hover: sigma_area.has-hover;
    out property <bool> kernel_has_hover: kernel_area.has-hover;

    VerticalLayout {
        padding: MaterialStyleMetrics.spacing_4;
        spacing: MaterialStyleMetrics.spacing_4;
        alignment: space-around;
        MaterialText {
            text: "Advanced Options";
            style: MaterialTypography.title_small;
        }
        
        // 1. Radial Distribution Group
        TouchArea {
            height: 48px;
            layout := HorizontalLayout {
                spacing: MaterialStyleMetrics.spacing_4;
                padding_left: MaterialStyleMetrics.spacing_4;
                padding_right: MaterialStyleMetrics.spacing_4;
                Icon {
                    colorize: MaterialPalette.on_surface_variant;
                    height: 24px;
                    width: 24px;
                    vertical-alignment: center;
                    source: root.rdf_expanded ? Icons.arrow_drop_down : Icons.arrow_right;
                }

                MaterialText {
                    text: "Radial Distribution";
                    style: MaterialTypography.title_small;
                    vertical-alignment: center;
                    color: MaterialPalette.on_surface_variant;
                }
            }

            clicked => {
                root.rdf_expanded = !root.rdf_expanded;
            }
        }

        VerticalLayout {
            height: root.rdf_height;
            opacity: root.rdf_expanded ? 1.0 : 0.0;
            animate height {
                duration: 250ms;
                easing: ease-in-out;
            }
            animate opacity {
                duration: 250ms;
                easing: ease-in-out;
            }
            spacing: MaterialStyleMetrics.spacing_8;
            padding_left: MaterialStyleMetrics.spacing_8; // Indent content
            r_max_area := TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "RDF Max r (Å)";
                    text <=> root.r_max;
                }
            }

            r_bin_area := TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "RDF Bin Width (Å)";
                    text <=> root.r_bin_width;
                }
            }
        }

        // 2. Structure Factor Group
        TouchArea {
            height: 48px;
            layout2 := HorizontalLayout {
                spacing: MaterialStyleMetrics.spacing_4;
                padding_left: MaterialStyleMetrics.spacing_4;
                padding_right: MaterialStyleMetrics.spacing_4;
                Icon {
                    colorize: MaterialPalette.on_surface_variant;
                    height: 24px;
                    width: 24px;
                    vertical-alignment: center;
                    source: root.sq_expanded ? Icons.arrow_drop_down : Icons.arrow_right;
                }

                MaterialText {
                    text: "Structure Factor";
                    style: MaterialTypography.title_small;
                    vertical-alignment: center;
                    color: MaterialPalette.on_surface_variant;
                }
            }

            clicked => {
                root.sq_expanded = !root.sq_expanded;
            }
        }

        VerticalLayout {
            height: root.sq_height;
            opacity: root.sq_expanded ? 1.0 : 0.0;
            animate height {
                duration: 250ms;
                easing: ease-in-out;
            }
            animate opacity {
                duration: 250ms;
                easing: ease-in-out;
            }
            spacing: MaterialStyleMetrics.spacing_8;
            padding_left: MaterialStyleMetrics.spacing_8;
            q_max_area := TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "Max Q (Å⁻¹)";
                    text <=> root.q_max;
                }
            }

            q_bin_area := TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "S(Q) Bin Width (Å⁻¹)";
                    text <=> root.q_bin_width;
                }
            }

            r_int_area := TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "Max r for the FFT (Å)";
                    text <=> root.r_int_max;
                }
            }
        }

        // 3. Bond Angle Group
        TouchArea {
            height: 48px;
            layout3 := HorizontalLayout {
                spacing: MaterialStyleMetrics.spacing_4;
                padding_left: MaterialStyleMetrics.spacing_4;
                padding_right: MaterialStyleMetrics.spacing_4;
                Icon {
                    colorize: MaterialPalette.on_surface_variant;
                    height: 24px;
                    width: 24px;
                    vertical-alignment: center;
                    source: root.angle_expanded ? Icons.arrow_drop_down : Icons.arrow_right;
                }

                MaterialText {
                    text: "Bond Angle";
                    style: MaterialTypography.title_small;
                    vertical-alignment: center;
                    color: MaterialPalette.on_surface_variant;
                }
            }

            clicked => {
                root.angle_expanded = !root.angle_expanded;
            }
        }

        VerticalLayout {
            height: root.angle_height;
            opacity: root.angle_expanded ? 1.0 : 0.0;
            animate height {
                duration: 250ms;
                easing: ease-in-out;
            }
            animate opacity {
                duration: 250ms;
                easing: ease-in-out;
            }
            spacing: MaterialStyleMetrics.spacing_8;
            padding_left: MaterialStyleMetrics.spacing_8;
            theta_bin_area := TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "PAD Bin Width (°)";
                    text <=> root.angle_bin_width;
                }
            }
        }

        // 4. Smoothing Group
        TouchArea {
            height: 48px;
            layout4 := HorizontalLayout {
                spacing: MaterialStyleMetrics.spacing_4;
                padding_left: MaterialStyleMetrics.spacing_4;
                padding_right: MaterialStyleMetrics.spacing_4;
                Icon {
                    colorize: MaterialPalette.on_surface_variant;
                    height: 24px;
                    width: 24px;
                    vertical-alignment: center;
                    source: root.smoothing_expanded ? Icons.arrow_drop_down : Icons.arrow_right;
                }

                MaterialText {
                    text: "Smoothing";
                    style: MaterialTypography.title_small;
                    vertical-alignment: center;
                    color: MaterialPalette.on_surface_variant;
                }
            }

            clicked => {
                root.smoothing_expanded = !root.smoothing_expanded;
            }
        }

        VerticalLayout {
            height: root.smoothing_height;
            opacity: root.smoothing_expanded ? 1.0 : 0.0;
            animate height {
                duration: 250ms;
                easing: ease-in-out;
            }
            animate opacity {
                duration: 250ms;
                easing: ease-in-out;
            }
            spacing: MaterialStyleMetrics.spacing_8;
            padding_left: MaterialStyleMetrics.spacing_8;
            sigma_area := TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "Smoothing Sigma";
                    text <=> root.smoothing_sigma;
                }
            }

            kernel_area := TouchArea {
                DropDownMenu {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "Smoothing Kernel";
                    items: [
                        { text: "Gaussian", enabled: true },
                        { text: "Bump", enabled: true },
                        { text: "Triweight", enabled: true }
                    ];
                    current-index <=> root.smoothing_kernel;
                }
            }
        }

        // 5. Bond Cutoffs Group
        TouchArea {
            height: 48px;
            layout5 := HorizontalLayout {
                spacing: MaterialStyleMetrics.spacing_4;
                padding_left: MaterialStyleMetrics.spacing_4;
                padding_right: MaterialStyleMetrics.spacing_4;
                Icon {
                    colorize: MaterialPalette.on_surface_variant;
                    height: 24px;
                    width: 24px;
                    vertical-alignment: center;
                    source: root.bond_cutoffs_expanded ? Icons.arrow_drop_down : Icons.arrow_right;
                }

                MaterialText {
                    text: "Bond Cutoffs";
                    style: MaterialTypography.title_small;
                    vertical-alignment: center;
                    color: MaterialPalette.on_surface_variant;
                }
            }

            clicked => {
                root.bond_cutoffs_expanded = !root.bond_cutoffs_expanded;
            }
        }

        VerticalLayout {
            height: root.bond_cutoffs_height;
            opacity: root.bond_cutoffs_expanded ? 1.0 : 0.0;
            animate height {
                duration: 250ms;
                easing: ease-in-out;
            }
            animate opacity {
                duration: 250ms;
                easing: ease-in-out;
            }
            spacing: MaterialStyleMetrics.spacing_8;
            padding_left: MaterialStyleMetrics.spacing_8;

            ScrollView {
                vertical-stretch: 0;
                height: min(list_layout.preferred-height, root.bond_cutoffs_height);
                viewport-height: list_layout.preferred-height;
                viewport-width: list_layout.preferred-width;
                list_layout := VerticalLayout {
                    spacing: MaterialStyleMetrics.spacing_4;
                    padding: MaterialStyleMetrics.padding_4;
                    for cutoff[i] in root.bond_cutoffs: HorizontalLayout {
                        alignment: center;
                        spacing: MaterialStyleMetrics.spacing_4;
                        MaterialText {
                            min-width: 80px;
                            text: cutoff.element1 + " - " + cutoff.element2 + ":";
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                        }

                        TextField {
                            enabled: root.file_loaded;
                            min-width: 100px;
                            text: cutoff.distance;
                            label: "Cutoff (Å)";
                            edited(s) => {
                                root.bond_cutoffs[i].distance = s;
                            }
                        }
                    }
                }
            }
        }
    }
}
