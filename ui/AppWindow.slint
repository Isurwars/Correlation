// Correlation - Liquid and Amorphous Solid Analysis Tool
// Copyright © 2013-2026 Isaías Rodríguez (isurwars@gmail.com)
// SPDX-License-Identifier: MIT
// Full license: https://github.com/Isurwars/Correlation/blob/main/LICENSE

import {
    MaterialPalette,
    MaterialStyleMetrics,
    MaterialTypography,
    MaterialText,
} from "@material";

import { AtomCount, BondCutoff } from "Types.slint";
import { InputFileCard } from "InputFileCard.slint";
import { FileInfoCard } from "FileInfoCard.slint"; 
import { OptionsCard } from "OptionsCard.slint";
import { RunAnalysisCard } from "RunAnalysisCard.slint";
import { AppToolTips } from "AppToolTips.slint";

export { AtomCount, BondCutoff }

export component AppWindow inherits Window {
    // Callback that the UI invokes on the C++ side
    callback run_analysis();
    callback write_files();
    callback browse_file();
    callback check_file_dialog_status();

    // Properties that C++ updates to change the UI
    in-out property <string> file_status_text: "Please load a structure file.";
    in-out property <string> analysis_status_text: "";
    in-out property <float> progress: 0.0;
    in-out property <bool> analysis_running: false;
    in-out property <bool> analysis_done: false;
    in-out property <bool> timer_running: false;
    in-out property <bool> text_opacity: true;
    in-out property <bool> file_loaded: true;

    // Data for the UI
    in-out property <int> num_frames: 0;
    in-out property <int> total_atoms: 0;
    in-out property <int> removed_frames_count: 0;
    in-out property <[AtomCount]> atom_counts: [];
    in-out property <[BondCutoff]> bond_cutoffs: [];
    in-out property <string> time_step: "1.0";

    // User-configurable options
    in-out property <string> in_file_text;
    in-out property <bool> smoothing: true;
    in-out property <bool> use_hdf5: true;
    in-out property <bool> use_csv: false;
    in-out property <string> r_max;
    in-out property <string> r_bin_width;
    in-out property <string> q_max;
    in-out property <string> q_bin_width;
    in-out property <string> r_int_max;
    in-out property <string> angle_bin_width;
    in-out property <string> smoothing_sigma;
    in-out property <int> smoothing_kernel: -1;
    in-out property <string> min_frame: "1";
    in-out property <string> max_frame: "End";

    property <bool> show_advanced_options: false;
    property <length> window_width: (root.file_loaded ? 398px : 198px) + (root.show_advanced_options ? 220px : 0px);
    property <length> window_height: root.file_loaded ? max(100px + file_info_card.preferred-height, 50px + options_card.preferred-height) : (input_card.preferred-height + 8px);

    width: root.window_width;
    animate width {
        duration: 100ms;
        easing: ease-in-out;
    }
    height: root.window_height;
    animate height {
        duration: 100ms;
        easing: ease-in-out;
    }
    background: MaterialPalette.background;
    default-font-size: MaterialTypography.body_small.font_size;
    default-font-weight: MaterialTypography.body_small.font_weight;
    property <image> logo-icon: @image-url("../Images/Logo.png");
    icon: logo-icon;

    timer := Timer {
        interval: 200ms;
        running: timer_running;
        triggered() => {
            check_file_dialog_status();
        }
    }

    window_area := TouchArea {
        HorizontalLayout {
            padding: MaterialStyleMetrics.padding_8;
            spacing: 0px;

            // 1. Sidebar: Input & File Info
            VerticalLayout {
                width: 190px;
                spacing: MaterialStyleMetrics.spacing_4;
                alignment: end;
                input_card := InputFileCard {
                    enabled: !root.timer_running;
                    browse_file => {
                        root.browse_file();
                    }
                }

                file_info_card := FileInfoCard {
                    height: root.height - input_card.preferred-height - 20px;
                    visible: root.file_loaded;
                    file_status_text <=> root.file_status_text;
                    file_loaded: root.file_loaded;
                    num_frames: root.num_frames;
                    total_atoms: root.total_atoms;
                    removed_frames_count: root.removed_frames_count;
                    atom_counts: root.atom_counts;
                    time_step <=> root.time_step;
                }
            }

            // 3. Right: Analysis Options
            VerticalLayout {
                width: root.show_advanced_options ? 220px : 0px;
                padding-left: MaterialStyleMetrics.padding_4;
                spacing: MaterialStyleMetrics.spacing_8;

                options_card := OptionsCard {
                    r_max <=> root.r_max;
                    r_bin_width <=> root.r_bin_width;
                    q_max <=> root.q_max;
                    q_bin_width <=> root.q_bin_width;
                    r_int_max <=> root.r_int_max;
                    angle_bin_width <=> root.angle_bin_width;
                    smoothing <=> root.smoothing;
                    smoothing_sigma <=> root.smoothing_sigma;
                    smoothing_kernel <=> root.smoothing_kernel;
                    bond_cutoffs <=> root.bond_cutoffs;
                }
            }

            // 2. Center: Output & Run
            VerticalLayout {
                width: root.file_loaded ? 200px : 0px;
                padding-left: MaterialStyleMetrics.padding_4;
                spacing: MaterialStyleMetrics.spacing_8;

                analysis_card := RunAnalysisCard {
                    file_loaded: root.file_loaded;
                    analysis_running: root.analysis_running;
                    analysis_done: root.analysis_done;
                    progress: root.progress;
                    analysis_status_text <=> root.analysis_status_text;
                    use_csv <=> root.use_csv;
                    use_hdf5 <=> root.use_hdf5;
                    min_frame <=> root.min_frame;
                    max_frame <=> root.max_frame;
                    advanced_options_visible <=> root.show_advanced_options;
                    run_analysis => {
                        root.analysis_status_text = "Running Analysis...";
                        root.run_analysis();
                    }
                    write_files => {
                        root.write_files();
                    }
                }
            }
        }

        AppToolTips {
            x: 0;
            y: 0;
            width: 100%;
            height: 100%;
            mouse_x: window_area.mouse-x;
            mouse_y: window_area.mouse-y;
            file_hover: input_card.file_area_has_hover;
            hdf5_hover: analysis_card.hdf5_area_has_hover;
            csv_hover: analysis_card.csv_area_has_hover;
            r_max_hover: options_card.r_max_has_hover;
            r_bin_hover: options_card.r_bin_has_hover;
            q_max_hover: options_card.q_max_has_hover;
            theta_bin_hover: options_card.theta_bin_has_hover;
            q_bin_hover: options_card.q_bin_has_hover;
            r_int_hover: options_card.r_int_has_hover;
            sigma_hover: options_card.sigma_has_hover;
            kernel_hover: options_card.kernel_has_hover;
        }
    }
}
