// Correlation - Liquid and Amorphous Solid Analysis Tool
// Copyright © 2013-2026 Isaías Rodríguez (isurwars@gmail.com)
// SPDX-License-Identifier: MIT
// Full license: https://github.com/Isurwars/Correlation/blob/main/LICENSE

import {
    MaterialPalette,
    MaterialStyleMetrics,
    MaterialTypography,
} from "@material";

import { AtomCount, BondCutoff } from "Types.slint";
import { InputFileCard } from "InputFileCard.slint";
import { FileInfoCard } from "FileInfoCard.slint"; 
import { OptionsCard } from "OptionsCard.slint";
import { BondCutoffsCard } from "BondCutoffsCard.slint";
import { RunAnalysisCard } from "RunAnalysisCard.slint";
import { AppToolTips } from "AppToolTips.slint";

export { AtomCount, BondCutoff }

export component AppWindow inherits Window {
    // Callback that the UI invokes on the C++ side
    callback run_analysis();
    callback browse_file();
    callback check_file_dialog_status();

    // Properties that C++ updates to change the UI
    in-out property <string> file_status_text: "Please load a structure file.";
    in-out property <string> analysis_status_text: "";
    in-out property <float> progress: 0.0;
    in-out property <bool> analysis_running: false;
    in-out property <bool> timer_running: false;
    in-out property <bool> text_opacity: true;
    in-out property <bool> file_loaded: false;

    // Data for the UI
    in-out property <[AtomCount]> atom_counts: [];
    in-out property <[BondCutoff]> bond_cutoffs: [];

    // User-configurable options
    in-out property <string> in_file_text;
    in-out property <bool> smoothing;
    in-out property <string> r_max;
    in-out property <string> r_bin_width;
    in-out property <string> q_max;
    in-out property <string> q_bin_width;
    in-out property <string> r_int_max;
    in-out property <string> angle_bin_width;
    in-out property <string> smoothing_sigma;
    in-out property <int> smoothing_kernel: 0;

    preferred-width: 500px;
    preferred-height: file_loaded ? (800px + bond_cutoffs.length * 50px) : 170px;
    min-width: 500px;
    min-height: file_loaded ? (800px + bond_cutoffs.length * 50px) : 170px;
    background: MaterialPalette.background;
    default-font-size: MaterialTypography.body_small.font_size;
    default-font-weight: MaterialTypography.body_small.font_weight;
    property <image> logo-icon: @image-url("../Images/Logo.png");
    icon: logo-icon;
    title: "Correlation Analysis Tool";

    timer := Timer {
        interval: 200ms;
        running: timer_running;
        triggered() => {
            check_file_dialog_status();
        }
    }

    window_area := TouchArea {
        VerticalLayout {
            padding: MaterialStyleMetrics.padding_16;
            spacing: MaterialStyleMetrics.spacing_16;

            input_card := InputFileCard {
                browse_file => {
                    root.browse_file();
                }
            }

            FileInfoCard {
                file_status_text <=> root.file_status_text;
                file_loaded: root.file_loaded;
                atom_counts: root.atom_counts;
            }

            options_card := OptionsCard {
                file_loaded: root.file_loaded;
                r_max <=> root.r_max;
                r_bin_width <=> root.r_bin_width;
                q_max <=> root.q_max;
                q_bin_width <=> root.q_bin_width;
                r_int_max <=> root.r_int_max;
                angle_bin_width <=> root.angle_bin_width;
                smoothing <=> root.smoothing;
                smoothing_sigma <=> root.smoothing_sigma;
                smoothing_kernel <=> root.smoothing_kernel;
            }

            BondCutoffsCard {
                file_loaded: root.file_loaded;
                bond_cutoffs <=> root.bond_cutoffs;
            }

            analysis_card := RunAnalysisCard {
                file_loaded: root.file_loaded;
                analysis_running: root.analysis_running;
                analysis_status_text <=> root.analysis_status_text;
                run_analysis => {
                    root.analysis_status_text = "Running Analysis...";
                    root.run_analysis();
                    root.analysis_status_text = "Analysis ended.";
                }
            }
        }

        AppToolTips {
            x: 0;
            y: 0;
            width: 100%;
            height: 100%;
            mouse_x: window_area.mouse-x;
            mouse_y: window_area.mouse-y;
            file_hover: input_card.file_area_has_hover;
            r_max_hover: options_card.r_max_has_hover;
            r_bin_hover: options_card.r_bin_has_hover;
            q_max_hover: options_card.q_max_has_hover;
            theta_bin_hover: options_card.theta_bin_has_hover;
            q_bin_hover: options_card.q_bin_has_hover;
            r_int_hover: options_card.r_int_has_hover;
            smooth_hover: options_card.smooth_has_hover;
            sigma_hover: options_card.sigma_has_hover;
            kernel_hover: options_card.kernel_has_hover;
        }
    }
}
