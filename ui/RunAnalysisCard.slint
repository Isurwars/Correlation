// Correlation - Liquid and Amorphous Solid Analysis Tool
// Copyright © 2013-2026 Isaías Rodríguez (isurwars@gmail.com)
// SPDX-License-Identifier: MIT
// Full license: https://github.com/Isurwars/Correlation/blob/main/LICENSE

import {
    MaterialPalette,
    MaterialStyleMetrics,
    MaterialTypography,
    FilledButton,
    FilledCard,
    MaterialText,
    CheckBox,
    CheckState,
    TextField,
    LinearProgressIndicator,
    Icons,
} from "@material";

export component RunAnalysisCard inherits FilledCard {
    in property <bool> file_loaded;
    in property <bool> analysis_running;
    in property <bool> analysis_done;
    in property <float> progress;
    in-out property <string> analysis_status_text;
    in-out property <bool> use_csv: true;
    in-out property <bool> use_hdf5: true;
    in-out property <string> min_frame;
    in-out property <string> max_frame;
    in-out property <bool> advanced_options_visible: false;
    callback run_analysis();
    callback write_files();

    // Hover state for tooltip
    out property <bool> analysis_area_has_hover: analysis_area.has-hover;
    out property <bool> hdf5_area_has_hover: hdf5_area.has-hover;
    out property <bool> csv_area_has_hover: csv_area.has-hover;

    VerticalLayout {
        padding: MaterialStyleMetrics.spacing_8;
        spacing: 0px;
        FilledButton {
            height: 40px;
            width: 90%;
            background: #d6d690;
            text: "Options";
            icon: root.advanced_options_visible ? Icons.arrow_right : Icons.arrow_left;
            clicked => {
                root.advanced_options_visible = !root.advanced_options_visible;
            }
        }

        // Export Options Block
        VerticalLayout {
            spacing: 0px;
            csv_area := TouchArea {
                height: 32px;
                HorizontalLayout {
                    padding: 0px;
                    MaterialText {
                        vertical-alignment: center;
                        text: "Export as CSV";
                        horizontal-stretch: 1;
                    }

                    CheckBox {
                        enabled: root.file_loaded;
                        check_state: root.use_csv ? CheckState.checked : CheckState.unchecked;
                        checked_state_changed(s) => {
                            root.use_csv = (s == CheckState.checked);
                        }
                    }
                }
            }

            hdf5_area := TouchArea {
                height: 32px;
                HorizontalLayout {
                    padding: 0px;
                    MaterialText {
                        vertical-alignment: center;
                        text: "Export as HDF5";
                        horizontal-stretch: 1;
                    }

                    CheckBox {
                        enabled: root.file_loaded;
                        check_state: root.use_hdf5 ? CheckState.checked : CheckState.unchecked;
                        checked_state_changed(s) => {
                            root.use_hdf5 = (s == CheckState.checked);
                        }
                    }
                }
            }
        }

        // Frame Range Block
        VerticalLayout {
            spacing: 0px;
            TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "Start Frame";
                    text <=> root.min_frame;
                }
            }

            TouchArea {
                TextField {
                    enabled: root.file_loaded;
                    width: 90%;
                    label: "End Frame";
                    text <=> root.max_frame;
                }
            }
        }

        // Action Buttons and Progress Bar Block
        VerticalLayout {
            spacing: 0px;
            padding: 0px;
            LinearProgressIndicator {
                width: 100%;
                progress: root.progress;
                indeterminate: false;
            }

            analysis_area := TouchArea {
                min-height: 40px;
                FilledButton {
                    height: 40px;
                    width: 100%;
                    background: #50b050;
                    text: root.analysis_running ? "In Progress..." : "Run Analysis";
                    enabled: root.file_loaded && !root.analysis_running;
                    clicked => {
                        root.run_analysis();
                    }
                }
            }

            write_area := TouchArea {
                min-height: 40px;
                FilledButton {
                    height: 40px;
                    width: 100%;
                    text: "Save";
                    enabled: root.analysis_done && !root.analysis_running;
                    clicked => {
                        root.write_files();
                    }
                }
            }
        }
    }
}
