// Correlation - Liquid and Amorphous Solid Analysis Tool
// Copyright © 2013-2026 Isaías Rodríguez (isurwars@gmail.com)
// SPDX-License-Identifier: MIT
// Full license: https://github.com/Isurwars/Correlation/blob/main/LICENSE

import {
    MaterialPalette,
    MaterialStyleMetrics,
    MaterialTypography,
    FilledButton,
    FilledCard,
    MaterialText,
    CheckBox,
    CheckState,
    TextField,
    LinearProgressIndicator,
    Icons,
    Icon,
} from "@material";
import { FileInfoCard } from "FileInfoCard.slint";

export component RunAnalysisCard inherits FilledCard {
    in property <bool> file_loaded;
    in property <bool> analysis_running;
    in property <bool> analysis_done;
    in property <float> progress;
    in-out property <string> analysis_status_text;
    in-out property <bool> use_csv: true;
    in-out property <bool> use_hdf5: true;
    in-out property <string> min_frame;
    in-out property <string> max_frame;
    in-out property <bool> advanced_options_visible;
    callback run_analysis();
    callback write_files();
    callback options_toggled(bool);

    // Hover state for tooltip
    out property <bool> analysis_area_has_hover: analysis_area.has-hover;
    out property <bool> hdf5_area_has_hover: hdf5_area.has-hover;
    out property <bool> csv_area_has_hover: csv_area.has-hover;

    VerticalLayout {
        padding: MaterialStyleMetrics.spacing_8;
        spacing: MaterialStyleMetrics.spacing_4;

        TouchArea {
            width: 100%;
            height: 40px;
            mouse-cursor: pointer;
            clicked => {
                root.advanced_options_visible = !root.advanced_options_visible;
                root.options_toggled(root.advanced_options_visible);
            }
            Rectangle {
                background: MaterialPalette.surface_container_highest;
                border-radius: MaterialStyleMetrics.border_radius_8;
                HorizontalLayout {
                    alignment: center;
                    spacing: 8px;
                    padding-left: 16px;
                    padding-right: 16px;
                    MaterialText {
                        text: "Options";
                        vertical-alignment: center;
                        style: MaterialTypography.label_large;
                    }

                    Icon {
                        y: 8px;
                        source: root.advanced_options_visible ? Icons.arrow_left : Icons.arrow_right;
                        width: 25px;
                        height: 25px;
                        vertical-alignment: center;
                    }
                }
            }
        }

        // Frame Range
        TouchArea {
            start_frame := TextField {
                enabled: root.file_loaded;
                width: 100%;
                label: "Start Frame";
                text <=> root.min_frame;
            }
        }

        TouchArea {
            end_frame := TextField {
                enabled: root.file_loaded;
                width: 100%;
                label: "End Frame";
                text <=> root.max_frame;
            }
        }

        // Export Options
        csv_area := TouchArea {
            HorizontalLayout {
                padding: 0px;
                MaterialText {
                    vertical-alignment: center;
                    text: "Export as CSV";
                    horizontal-stretch: 1;
                }

                CheckBox {
                    enabled: root.file_loaded;
                    check_state: root.use_csv ? CheckState.checked : CheckState.unchecked;
                    checked_state_changed(s) => {
                        root.use_csv = (s == CheckState.checked);
                    }
                }
            }
        }

        hdf5_area := TouchArea {
            HorizontalLayout {
                padding: 0px;
                MaterialText {
                    vertical-alignment: center;
                    text: "Export as HDF5";
                    horizontal-stretch: 1;
                }

                CheckBox {
                    enabled: root.file_loaded;
                    check_state: root.use_hdf5 ? CheckState.checked : CheckState.unchecked;
                    checked_state_changed(s) => {
                        root.use_hdf5 = (s == CheckState.checked);
                    }
                }
            }
        }

        // Action Buttons and Progress Bar
        LinearProgressIndicator {
            width: 100%;
            height: 8px;
            progress: root.progress;
            indeterminate: false;
        }

        analysis_area := TouchArea {
            FilledButton {
                width: 100%;
                text: root.analysis_running ? "In Progress..." : "Run Analysis";
                enabled: root.file_loaded && !root.analysis_running;
                clicked => {
                    root.run_analysis();
                }
            }
        }

        write_area := TouchArea {
            FilledButton {
                width: 100%;
                text: "Save Results";
                enabled: root.analysis_done && !root.analysis_running;
                clicked => {
                    root.write_files();
                }
            }
        }
    }
}
